@inherits LayoutComponentBase
@using AdminShellNS;
@using AasxPackageLogic;
@using AasxPackageLogic.PackageCentral;
@inject BlazorUI.Data.blazorSessionService bi

@{
    // resharper disable all
}

@*@<div class="sidebar">
        <NavMenu />
    </div>
    <div class="top-row px-4">
    <tr style="max-height:100%">
*@
<div class="main">
    <div class="top-row px-5">
        <div class="col-12 row">
            <table border="0" cellspacing="2">
                <tr>
                    <td nowrap>
                        <span style="font-weight:bold">Enter URL or *:</span>
                        <span>&nbsp&nbsp&nbsp&nbsp</span>
                    </td>
                    <td nowrap>
                        @{
                            string text = "";
                            int ww = 80;
                            <input size="@ww" value="@text"
                                   @onchange="@((ChangeEventArgs __e) => MyTextInput(__e.Value.ToString()))" />
                        }
                        @code {
                            private async void MyTextInput(string value)
                            {
                                try
                                {
                                    value = value.ToLower();
                                    if (value != "" && (value.Contains("http://") || value.Contains("https://")))
                                    {
                                        if (value.Contains("getaasx"))
                                        {
                                            await InvokeAsync(async () => await Program.getAasxAsync(bi, value));
                                        }
                                        else // repo
                                        {
                                            string fn = value;
                                            var fr = PackageContainerListFactory.GuessAndCreateNew(fn);
                                            // Program._packageCentral.Repositories.Add(fr);
                                            bi.repository = fr as PackageContainerListHttpRestRepository;
                                            var task = Task.Run(async () => await bi.repository.SyncronizeFromServerAsync());
                                            var r = task.Result;
                                            if (bi.repository.FileMap.Count > 0)
                                            {
                                                bi.aasxFiles = new string[bi.repository.FileMap.Count];
                                                for (int i = 0; i < bi.repository.FileMap.Count; i++)
                                                {
                                                    bi.aasxFiles[i] = bi.repository.FileMap[i].InfoIds;
                                                }
                                                var repoFile = bi.repository.FileMap[0];
                                                bi.container = PackageContainerFactory.GuessAndCreateFor(bi._packageCentral, repoFile.InfoLocation, repoFile.InfoLocation, overrideLoadResident: true);
                                                bi.env = bi.container.Env;
                                                bi.aasxFileSelected = "";
                                                bi.editMode = false;
                                                bi.thumbNail = null;
                                                Program.signalNewData(3, bi.sessionNumber);
                                            }
                                        }
                                    }
                                    if (value == "*" || value == "*.*")
                                    {
                                        bi.repository = null;
                                        await InvokeAsync(() => Program.loadAasxFiles(bi, true));
                                    }
                                }
                                catch
                                {
                                }
                                this.StateHasChanged();
                            }
                        }
                        <span>&nbsp&nbsp&nbsp&nbsp</span>
                    </td>
                    <td nowrap></td>
                    <td>
                        <button @onclick="toggleEditMode">
                            @{
                                if (bi.editMode)
                                {
                                    <span>EditMode is ON</span>
                                }
                                else
                                {
                                    <span>EditMode is OFF</span>
                                }
                                Program.signalNewData(0, bi.sessionNumber);
                            }
                        </button>
                        @code {
                            private void toggleEditMode()
                            {
                                bi.editMode = !bi.editMode;
                                this.StateHasChanged();
                            }
                        }
                        <span>&nbsp&nbsp&nbsp&nbsp</span>
                    </td>
                    <td nowrap>
                    </td>
                </tr>
                <tr>
                    <td nowrap>
                        <span style="font-weight:bold">Select:</span>
                        <span>&nbsp&nbsp&nbsp&nbsp</span>
                    </td>
                    <td nowrap>
                        @{

                            // string w = (bi.aasxFileSelected.Length * 11 + 60).ToString() + "px";
                            // w = "50%";
                            // string w = "70%"; style="width:@w" height:20px; line-height: 20px class="form-control selectpicker" display:inline-block
                            <select style="width:100%;max-width:100%;height:30px" value="@bi.aasxFileSelected"
                                    @onchange="@((ChangeEventArgs __e) => MyAasxSelect(__e.Value.ToString()))">
                                @foreach (var item in bi.aasxFiles)
                                {
                                    <option value="@item">@item</option>
                                }
                            </select>
                            @code {
                                private async void MyAasxSelect(string value)
                                {
                                    try
                                    {
                                        if (bi.repository?.FileMap?.Count > 0)
                                        {
                                            for (int i = 0; i < bi.repository.FileMap.Count; i++)
                                            {
                                                if (value == bi.repository.FileMap[i].InfoIds)
                                                {
                                                    var repoFile = bi.repository.FileMap[i];
                                                    bi.container = PackageContainerFactory.GuessAndCreateFor(bi._packageCentral, repoFile.InfoLocation, repoFile.InfoLocation, overrideLoadResident: true);
                                                    bi.env = bi.container.Env;
                                                    bi.aasxFileSelected = "";
                                                    bi.editMode = false;
                                                    bi.thumbNail = null;
                                                    Program.signalNewData(3, bi.sessionNumber);
                                                }
                                            }
                                        }
                                        else if (bi.aasxFiles?.Length > 0)
                                        {
                                            await InvokeAsync(() => Program.loadAasx(bi, value));
                                        }
                                    }
                                    catch
                                    {
                                    }
                                    this.StateHasChanged();
                                }
                            }
                        }
                    </td>
                    <td nowrap>
                        <span>&nbsp&nbsp&nbsp&nbsp</span>
                        <span style="font-weight:bold">Upload:</span>
                    </td>
                    <td nowrap>
                        @*<a href="https://docs.microsoft.com/aspnet/" target="_blank">About</a>
                        *@
                        <InputFile OnChange="HandleFileSelected" />
                        <span>&nbsp&nbsp&nbsp&nbsp</span>
                        @code {
                            // resharper disable once UnusedField.Compiler
                            IFileListEntry file;

                            async Task HandleFileSelected(IFileListEntry[] files)
                            {
                                var file = files.FirstOrDefault();
                                if (file != null)
                                {
                                    var fileStream = System.IO.File.Create(file.Name);
                                    await file.Data.CopyToAsync(fileStream);
                                    fileStream.Close();
                                    bi.repository = null;
                                    await InvokeAsync(() => Program.loadAasxFiles(bi, false));
                                    await InvokeAsync(() => Program.loadAasx(bi, file.Name));
                                    this.StateHasChanged();
                                }
                            }
                        }
                    </td>
                    <td nowrap>
                        <button @onclick="onSave">Save</button>
                        @*<span>&nbsp&nbsp&nbsp&nbsp</span>*@
                        @*<button href="/download">Download</button>*@
                        @*<a class="form-control btn btn-primary" href="/download" style="color:black;background-color:transparent;">Download</a>*@
                        <a class="button" href="/download">Download</a>
                        <span>&nbsp&nbsp&nbsp&nbsp</span>
                        @code {
                            private async void onSave()
                            {
                                try
                                {
                                    if (bi.repository?.FileMap?.Count > 0)
                                    {
                                        if (bi.container != null)
                                        {
                                            await InvokeAsync(() => bi.container.SaveToSourceAsync());
                                        }
                                    }
                                    else if (bi.aasxFiles?.Length > 0)
                                    {
                                        if (bi.aasxFileSelected != "")
                                        {
                                            bi.env.SaveAs(bi.aasxFileSelected);
                                        }
                                    }
                                }
                                catch
                                {
                                }
                                this.StateHasChanged();
                            }
                        }
                        @code {
                            private async void Download()
                            {
                                // to be done
                                /*
                                if (!System.IO.Directory.Exists("./temp/"))
                                    System.IO.Directory.CreateDirectory("./temp/");
                                string fname = "./temp/" + System.IO.Path.GetFileName(Program.env.AasEnv.AdministrationShells[0].idShort);
                                Program.env.SaveAs(fname);

                                // return as FILE
                                System.IO.FileStream packageStream = File.OpenRead(fname);
                                context.Response.StatusCode = HttpStatusCode.Ok;
                                SendStreamResponse(context, packageStream,
                                    Path.GetFileName(AasxServer.Program.envFileName[fileIndex]));
                                packageStream.Close();
                                */
                                this.StateHasChanged();
                            }
                        }
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <div class="content px-4">
        @Body
    </div>
</div>
